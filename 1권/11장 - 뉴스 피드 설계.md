# 11장 - 뉴스 피드 설계

## 1단계 : 문제 이해 및 설계 범위 확정

* 플랫폼 지원
  * 모바일 앱, 웹 지원
* 기능 요건
  * 뉴스 피드 페이지에 새로운 스토리 업로드
  * 친구들이 올리는 스토리 확인
* 뉴스피드 순서 (최신? 가까운 친구? 토픽 점수?)
  * 시간 흐름 역순
* 최대 친구 수
  * 5천명
* 트래픽 규모
  * 매일 천만명
* 미디어 포함
  * 이미지, 비디오

## 2단계 개략적 설계안 제시 및 동의 구하기
* 피드 발행 : 스토리 포스팅 -> DB와 캐시에 기록 -> 친구의 뉴스피드에 전송
* 뉴스 피드 생성 : 모든 친구의 포스팅을 시간 흐름 역순으로 만들기

### 뉴스 피드 API
#### 피드 발행 API
* POST /v1/me/feed
* body : 포스팅 내용
* Authorization 헤더 : API 호출을 인증하기 위해 사용
#### 피드 읽기 API
* GET /v1/me/feed
* Authorization 헤더 : API 호출을 인증하기 위해 사용

### 피드 발행 시스템
![](11%EC%9E%A5%20-%20%EB%89%B4%EC%8A%A4%20%ED%94%BC%EB%93%9C%20%EC%84%A4%EA%B3%84/image.png)<!-- {"width":365} -->
* 포스팅 저장 : 포스팅 DB와 포스팅 캐시에 저장
* 포스팅 전송 : 친구 피드 캐시에 push
* 알림 서비스 : 새 포스팅 알림 푸시

### 뉴스 피드 생성
GET /v1/me/feed 접근이 피드 캐시 조회
![](11%EC%9E%A5%20-%20%EB%89%B4%EC%8A%A4%20%ED%94%BC%EB%93%9C%20%EC%84%A4%EA%B3%84/image%202.png)<!-- {"width":298} -->

## 3단계 상세 설계
* 웹서버 : 인증 토큰 처리, 스팸방지를 위한 처리율 제한
* 포스팅 전송 (팬아웃) : 새 포스팅을 친구 관계에 모든 사용자에게 전달
  ![](11%EC%9E%A5%20-%20%EB%89%B4%EC%8A%A4%20%ED%94%BC%EB%93%9C%20%EC%84%A4%EA%B3%84/image%203.png)<!-- {"width":475} -->

### 포스팅 전송(팬아웃) 서비스
* 쓰기 시점에 팬아웃하는 모델 (push 모델)
  * 장점
    * 뉴스 피드가 실시간으로 갱신됨
    * 친구에게 즉시 전송됨
    * 뉴스피드 읽는 시간이 짧아짐
  * 단점
    * 친구가 많으면, 친구 모두의 피드에 push 하는데 많은 시간 소요
      * hotkey 문제
    * 서비스를 자주 이용하지 않는 친구에게도 push 하느라 낭비
* 읽기 시점에 팬아웃하는 모델 (pull 모델)
  * 장점
    * 비활성화 사용자가 많으면 유리한 모델, 로그인 전까지 자원 X
    * 핫키 문제 안생김
  * 단점
    * 뉴스피드 읽는 시간이 늘어남


예시에선 친구나 팔로워 많은 사용자의 경우에만 pull 모델 사용하자.
![](11%EC%9E%A5%20-%20%EB%89%B4%EC%8A%A4%20%ED%94%BC%EB%93%9C%20%EC%84%A4%EA%B3%84/image%204.png)<!-- {"width":479} -->
1. 친구 ID 목록을 추출
2. 친구 ID로 친구 정보 목록 조회
3. 친구 목록과 새 포스팅 ID 목록을 메시지 큐에 보냄
4. 전송 작업서버가 <포스팅 ID, 사용자 ID> 로 매핑 테이블 저장
   * 따라서 새 포스팅이 생길때 마다 새 레코드 추가
   * ID만 저장하는 이유는 메모리 요구량을 줄이기 위해
   * 또한 메모리 크기 적절히 제한 필요
     * 어떤 사용자가 모든 스토리를 볼 일이 없음
     * 최신만 유지되도록 제한해도 캐시 미스 X

### 피드 읽기 흐름 설계
![](11%EC%9E%A5%20-%20%EB%89%B4%EC%8A%A4%20%ED%94%BC%EB%93%9C%20%EC%84%A4%EA%B3%84/image%205.png)<!-- {"width":565} -->
* GET /v1/me/feed 요청
* 로드밸런서 -> 웹서버
* 웹서버 -> 뉴스피드 서비스 호출
* 뉴스피드 서비스
  * (4) 에서 피드 캐시를 불러옴
  * (5) 에서 사용자와 포스팅 캐시를 불러옴
  * 피드 캐시 + 사용자 캐시 + 포스팅 캐시 조합



#대규모시스템설계기초
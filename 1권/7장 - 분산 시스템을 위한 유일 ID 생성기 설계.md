# 7장 - 분산 시스템을 위한 유일 ID 생성기 설계 
* auto_increment 쓰면 되지 않을까?
  * 분산 환경에서 DB 서버 한대로는 요구 감당 어려움
  * 여러 DB 서버인 경우 지연 시간을 낮추기 어려움
>  간혹 auto_increment 가 URL 로 노출될때 회원수, 주문수를 간접적으로 노출 하게 되는 이슈

## 1단계 - 문제 이해 및 설계 범위 확정
질문으로 모호함 없애기
* 유일해야 하는가?
* 정렬 가능해야 하는가?
* 새로운 레코드는 항상 1만큼 커야 하나?
  * 시간 흐름에 따라 커저야 한다. 1만큼 커질필요는 없다.
* 숫자로만 구성되는가?
* 시스템 규모는?
  * 초당 10,000 ID 생성 가능해야 한다.

## 2단계 - 개략적인 설계안 제시 및 동의 구하기
ID 생성 접근법 선택지 살펴보기

>  커머스는 주문 쓰기트래픽이 생각보다 엄청나지 않다.
> 주문의 결제, 선택 단계도 있어서인지 10tps도 안된걸로 기억
> 그래서인지 주문번호는 굉장히 단순하고 오래된 채번 시스템임에도 불구하고 잘 동작하는걸로 기억
> 레거시는 허접한 로직이어도 검증되긴 했으니 보통 문제가 생기지 않으면 바뀌지 않는다
> 물론 지금은 개편했을 수 있음
> 주문번호 채번은 상담원의 가시성이 더 중요한걸로 생각
> (yyymmddss + 랜덤 문자열? + 충돌 후 해결)

> 상품번호도 가시성 위주로 기억
> (관리자가 직접 등록하고, 등록과정도 복잡)
> 상품군 영문 분류 + 랜덤문자열 + 충돌 후 해결

>  회원은 국내 상대면 많아봐야 최대 5천만..
> auto increment

>  장바구니는 쓰기가 많아 (수십억)
> Int 로 취급하기 어려워서 다른걸 선택하신걸 본듯

### 다중 마스터 복제
데이터베이스 서버 수 만큼 ID 증가 (ex: 2대인경우 ID += 2)
* 여러 데이터센터에 걸쳐 규모를 늘리기 어렵다.
* 시간 흐름에 맞추어 커지는 요구사항 불가
* 서버 추가/삭제에 대응 불가
### UUID
* 128bit 유일 식별키
* 중복 UUID 1개가 발생가능성을 50%로 만들려면?
  * 초당 10억개의 UUID를 100년동안 계속해서 만들어야 함
* 장점
  * 만드는방법 단순함, 독립적, 동기화 이슈 없음
  * 서버가 각자 만듬, 규모 확장도 문제 없음
* 단점
  * 128비트라서 길다, 요구사항은 64비트
  * 시간순으로 정렬하는 요구사항 불가
  * ID에 숫자가 아닌 값이 포함되어 요구사항 불가
>  DBA 분이 싫어하셨던 기억
> 정렬이 안되서 운영 데이터를 확인할때 보기 어렵
> 너무 길다보니 눈으로 구분하기 어려웠던 기억
### 티켓 서버
N개의 웹서버가 auto_increment 기능을 갖춘 티켓서버를 호출하여 ID를 채번하는 형태 (중앙 집중)
* 구현 쉬움, 유일성 보장 쉬움, 중소 규모에 적합
* 티켓서버가 SPOF가 된다. 여러대로 늘렸을때 이슈 등
### 트위터 스노플레이크
* 사인(sign) 비트 : 1비트
  * 쓰이지 않지만 나중을 위해 둠 (음수/양수)
* 타임스탬프 : 41비트
  * 시간 흐름순 요구사항 충족
  * 현재시간ms-기원시간ms (ex: 서비스 오픈일시)
  * 41 비트로는 최대 69년 까지 사용 가능
  * 69년 뒤에는 마이그레이션 필요
* 데이터센터 ID : 5비트
  * 2^5=32개의 데이터 센터까지 확장 가능
* 서버 ID : 5비트
  * 데이터센터당  32개 서버 사용 가능
* 일련번호 :  12비트
  * 각 서버별로 ID += 1 증가
  * 2^12=4096개 값

## 4단계 마무리
요구사항을 위해 스노우 플레이크 채택
* 시간이 남는다면?
  * 시계 동기화
    * 여러서버가 다른 시간일 수 있음
    * NTP가 보편적인 수단이라고 한다
  * 각 절의 길이 최적화
    * 동시성이 낮고 수명이 긴 어플리케이션이면 일련번호를 줄이고 타임스탬프를 늘릴 수 있다
  * 고가용성
    * 아주 높은 가용성을 제공해야 함

#대규모시스템설계기초